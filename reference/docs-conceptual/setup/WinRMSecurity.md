---
ms.date: 06/05/2017
keywords: PowerShell, o cmdlet
title: WinRMSecurity
ms.openlocfilehash: 43e77067e301cdf1b792cb0d24b72ee0abb3349a
ms.sourcegitcommit: 735ccab3fb3834ccd8559fab6700b798e8e5ffbf
ms.translationtype: MT
ms.contentlocale: pt-PT
ms.lasthandoff: 05/25/2018
---
# <a name="powershell-remoting-security-considerations"></a><span data-ttu-id="b00cd-103">Considerações de segurança de comunicação remota do PowerShell</span><span class="sxs-lookup"><span data-stu-id="b00cd-103">PowerShell Remoting Security Considerations</span></span>

<span data-ttu-id="b00cd-104">Comunicação remota do PowerShell é a forma recomendada para gerir sistemas Windows.</span><span class="sxs-lookup"><span data-stu-id="b00cd-104">PowerShell Remoting is the recommended way to manage Windows systems.</span></span> <span data-ttu-id="b00cd-105">Comunicação remota do PowerShell está ativada por predefinição no Windows Server 2012 R2.</span><span class="sxs-lookup"><span data-stu-id="b00cd-105">PowerShell Remoting is enabled by default in Windows Server 2012 R2.</span></span> <span data-ttu-id="b00cd-106">Este documento abrange as questões de segurança, recomendações e melhores práticas quando utilizar a comunicação remota do PowerShell.</span><span class="sxs-lookup"><span data-stu-id="b00cd-106">This document covers security concerns, recommendations, and best practices when using PowerShell Remoting.</span></span>

## <a name="what-is-powershell-remoting"></a><span data-ttu-id="b00cd-107">O que é a comunicação remota do PowerShell?</span><span class="sxs-lookup"><span data-stu-id="b00cd-107">What is PowerShell Remoting?</span></span>

<span data-ttu-id="b00cd-108">Utiliza a comunicação remota do PowerShell [gestão remota do Windows (WinRM)](https://msdn.microsoft.com/library/windows/desktop/aa384426.aspx), que é a implementação Microsoft do [serviços Web para gestão (WS-Management)](http://www.dmtf.org/sites/default/files/standards/documents/DSP0226_1.2.0.pdf) protocolo, para permitir aos utilizadores executar o PowerShell comandos em computadores remotos.</span><span class="sxs-lookup"><span data-stu-id="b00cd-108">PowerShell Remoting uses [Windows Remote Management (WinRM)](https://msdn.microsoft.com/library/windows/desktop/aa384426.aspx), which is the Microsoft implementation of the [Web Services for Management (WS-Management)](http://www.dmtf.org/sites/default/files/standards/documents/DSP0226_1.2.0.pdf) protocol, to allow users to run PowerShell commands on remote computers.</span></span> <span data-ttu-id="b00cd-109">Pode encontrar mais informações sobre como utilizar a comunicação remota do PowerShell em [executar comandos remotos](https://technet.microsoft.com/library/dd819505.aspx).</span><span class="sxs-lookup"><span data-stu-id="b00cd-109">You can find more information about using PowerShell Remoting at [Running Remote Commands](https://technet.microsoft.com/library/dd819505.aspx).</span></span>

<span data-ttu-id="b00cd-110">Comunicação remota do PowerShell não é igual a utilizar o **ComputerName** parâmetro de um cmdlet executá-la num computador remoto, que utiliza a chamada de procedimento remoto (RPC) do respetivo protocolo subjacente.</span><span class="sxs-lookup"><span data-stu-id="b00cd-110">PowerShell Remoting is not the same as using the **ComputerName** parameter of a cmdlet to run it on a remote computer, which uses Remote Procedure Call (RPC) as its underlying protocol.</span></span>

## <a name="powershell-remoting-default-settings"></a><span data-ttu-id="b00cd-111">Definições predefinidas da gestão remota de PowerShell</span><span class="sxs-lookup"><span data-stu-id="b00cd-111">PowerShell Remoting default settings</span></span>

<span data-ttu-id="b00cd-112">Comunicação remota do PowerShell (e WinRM) escutarem nas portas seguintes:</span><span class="sxs-lookup"><span data-stu-id="b00cd-112">PowerShell Remoting (and WinRM) listen on the following ports:</span></span>

- <span data-ttu-id="b00cd-113">HTTP: 5985</span><span class="sxs-lookup"><span data-stu-id="b00cd-113">HTTP: 5985</span></span>
- <span data-ttu-id="b00cd-114">HTTPS: 5986</span><span class="sxs-lookup"><span data-stu-id="b00cd-114">HTTPS: 5986</span></span>

<span data-ttu-id="b00cd-115">Por predefinição, comunicação remota do PowerShell só permite que as ligações dos membros do grupo Administradores.</span><span class="sxs-lookup"><span data-stu-id="b00cd-115">By default, PowerShell Remoting only allows connections from members of the Administrators group.</span></span> <span data-ttu-id="b00cd-116">As sessões são iniciadas no contexto do utilizador, para que todos os controlos de acesso do sistema operativo aplicada a utilizadores individuais e grupos continuam a aplicar aos mesmos enquanto estiver ligado através de comunicação remota do PowerShell.</span><span class="sxs-lookup"><span data-stu-id="b00cd-116">Sessions are launched under the user's context, so all operating system access controls applied to individual users and groups continue to apply to them while connected over PowerShell Remoting.</span></span>

<span data-ttu-id="b00cd-117">Em redes privadas, a regra de Firewall do Windows predefinida para a gestão remota de PowerShell aceita todas as ligações.</span><span class="sxs-lookup"><span data-stu-id="b00cd-117">On private networks, the default Windows Firewall rule for PowerShell Remoting accepts all connections.</span></span> <span data-ttu-id="b00cd-118">Em redes públicas, a regra de Firewall do Windows predefinida permite ligações de comunicação remota do PowerShell apenas a partir de dentro da mesma sub-rede.</span><span class="sxs-lookup"><span data-stu-id="b00cd-118">On public networks, the default Windows Firewall rule allows PowerShell Remoting connections only from within the same subnet.</span></span> <span data-ttu-id="b00cd-119">Tem de alterar explicitamente dessa regra para abrir a comunicação remota do PowerShell para todas as ligações de uma rede pública.</span><span class="sxs-lookup"><span data-stu-id="b00cd-119">You have to explicitly change that rule to open PowerShell Remoting to all connections on a public network.</span></span>

><span data-ttu-id="b00cd-120">**Aviso:** destina-se a regra de firewall para redes públicas para proteger o computador de tentativas de ligação externa potencialmente maliciosas.</span><span class="sxs-lookup"><span data-stu-id="b00cd-120">**Warning:** The firewall rule for public networks is meant to protect the computer from potentially malicious external connection attempts.</span></span> <span data-ttu-id="b00cd-121">Tenha cuidado ao remover esta regra.</span><span class="sxs-lookup"><span data-stu-id="b00cd-121">Use caution when removing this rule.</span></span>

## <a name="process-isolation"></a><span data-ttu-id="b00cd-122">Isolamento de processo</span><span class="sxs-lookup"><span data-stu-id="b00cd-122">Process isolation</span></span>

<span data-ttu-id="b00cd-123">Utiliza a comunicação remota do PowerShell [gestão remota do Windows (WinRM)](https://msdn.microsoft.com/library/windows/desktop/aa384426) para comunicação entre computadores.</span><span class="sxs-lookup"><span data-stu-id="b00cd-123">PowerShell Remoting uses [Windows Remote Management (WinRM)](https://msdn.microsoft.com/library/windows/desktop/aa384426) for communication between computers.</span></span>
<span data-ttu-id="b00cd-124">WinRM é executado como um serviço sob a conta de serviço de rede e cria isolados processos em execução como contas de utilizador para instâncias do PowerShell de anfitrião.</span><span class="sxs-lookup"><span data-stu-id="b00cd-124">WinRM runs as a service under the Network Service account, and spawns isolated processes running as user accounts to host PowerShell instances.</span></span> <span data-ttu-id="b00cd-125">Uma instância do PowerShell em execução como um utilizador não tem acesso a um processo em execução uma instância do PowerShell como outro utilizador.</span><span class="sxs-lookup"><span data-stu-id="b00cd-125">An instance of PowerShell running as one user has no access to a process running an instance of PowerShell as another user.</span></span>

## <a name="event-logs-generated-by-powershell-remoting"></a><span data-ttu-id="b00cd-126">Registos de eventos gerados pela comunicação remota do PowerShell</span><span class="sxs-lookup"><span data-stu-id="b00cd-126">Event logs generated by PowerShell Remoting</span></span>

<span data-ttu-id="b00cd-127">FireEye tiver fornecido um resumo dos registos de eventos e outras provas de segurança gerados pelo sessões de comunicação remota do PowerShell, disponíveis em boa [investigar PowerShell ataques](https://www.fireeye.com/content/dam/fireeye-www/global/en/solutions/pdfs/wp-lazanciyan-investigating-powershell-attacks.pdf).</span><span class="sxs-lookup"><span data-stu-id="b00cd-127">FireEye has provided a good summary of the event logs and other security evidence generated by PowerShell Remoting sessions, available at [Investigating PowerShell Attacks](https://www.fireeye.com/content/dam/fireeye-www/global/en/solutions/pdfs/wp-lazanciyan-investigating-powershell-attacks.pdf).</span></span>

## <a name="encryption-and-transport-protocols"></a><span data-ttu-id="b00cd-128">Protocolos de encriptação e de transporte</span><span class="sxs-lookup"><span data-stu-id="b00cd-128">Encryption and transport protocols</span></span>

<span data-ttu-id="b00cd-129">É útil considerar a segurança de uma ligação de comunicação remota do PowerShell de duas perspetivas: autenticação inicial e a comunicação em curso.</span><span class="sxs-lookup"><span data-stu-id="b00cd-129">It is helpful to consider the security of a PowerShell Remoting connection from two perspectives: initial authentication, and ongoing communication.</span></span>

<span data-ttu-id="b00cd-130">O protocolo de transporte utilizado (HTTP ou HTTPS), independentemente de comunicação remota do PowerShell encripta sempre todas as comunicações após a autenticação inicial com uma chave simétrica por sessão AES 256.</span><span class="sxs-lookup"><span data-stu-id="b00cd-130">Regardless of the transport protocol used (HTTP or HTTPS), PowerShell Remoting always encrypts all communication after initial authentication with a per-session AES-256 symmetric key.</span></span>

### <a name="initial-authentication"></a><span data-ttu-id="b00cd-131">Autenticação inicial</span><span class="sxs-lookup"><span data-stu-id="b00cd-131">Initial authentication</span></span>

<span data-ttu-id="b00cd-132">Autenticação confirma a identidade do cliente para o servidor - e Idealmente - o servidor para o cliente.</span><span class="sxs-lookup"><span data-stu-id="b00cd-132">Authentication confirms the identity of the client to the server - and ideally - the server to the client.</span></span>

<span data-ttu-id="b00cd-133">Quando um cliente liga a um servidor de domínio utilizando o respetivo nome de computador (ou seja,: servidor01, ou server01.contoso.com), o protocolo de autenticação predefinido é [Kerberos](https://msdn.microsoft.com/library/windows/desktop/aa378747.aspx).</span><span class="sxs-lookup"><span data-stu-id="b00cd-133">When a client connects to a domain server using its computer name (i.e.: server01, or server01.contoso.com), the default authentication protocol is [Kerberos](https://msdn.microsoft.com/library/windows/desktop/aa378747.aspx).</span></span>
<span data-ttu-id="b00cd-134">Kerberos garante a identidade de utilizador e a identidade do servidor sem enviar algum tipo de credencial reutilizável.</span><span class="sxs-lookup"><span data-stu-id="b00cd-134">Kerberos guarantees both the user identity and server identity without sending any sort of reusable credential.</span></span>

<span data-ttu-id="b00cd-135">Quando um cliente liga a um servidor de domínio utilizando o respetivo endereço IP ou liga a um servidor de grupo de trabalho, a autenticação Kerberos não é possível.</span><span class="sxs-lookup"><span data-stu-id="b00cd-135">When a client connects to a domain server using its IP address, or connects to a workgroup server, Kerberos authentication is not possible.</span></span> <span data-ttu-id="b00cd-136">Nesse caso, a comunicação remota do PowerShell baseia-se no [protocolo de autenticação de NTLM](https://msdn.microsoft.com/library/windows/desktop/aa378749.aspx).</span><span class="sxs-lookup"><span data-stu-id="b00cd-136">In that case, PowerShell Remoting relies on the [NTLM authentication protocol](https://msdn.microsoft.com/library/windows/desktop/aa378749.aspx).</span></span> <span data-ttu-id="b00cd-137">O protocolo de autenticação de NTLM garante a identidade do utilizador sem enviar algum tipo de credencial delegable.</span><span class="sxs-lookup"><span data-stu-id="b00cd-137">The NTLM authentication protocol guarantees the user identity without sending any sort of delegable credential.</span></span> <span data-ttu-id="b00cd-138">Para comprovar a identidade do utilizador, o protocolo NTLM requer que o cliente e o servidor computação uma chave de sessão de palavra-passe do utilizador sem nunca trocar a palavra-passe em si.</span><span class="sxs-lookup"><span data-stu-id="b00cd-138">To prove user identity, the NTLM protocol requires that both the client and server compute a session key from the user's password without ever exchanging the password itself.</span></span> <span data-ttu-id="b00cd-139">O servidor, normalmente, não sabe palavra-passe do utilizador para comunicar com o controlador de domínio, o que saber a palavra-passe do utilizador e calcula a chave de sessão para o servidor.</span><span class="sxs-lookup"><span data-stu-id="b00cd-139">The server typically does not know the user's password, so it communicates with the domain controller, which does know the user's password and calculates the session key for the server.</span></span>

<span data-ttu-id="b00cd-140">O protocolo NTLM, no entanto, garante a identidade do servidor.</span><span class="sxs-lookup"><span data-stu-id="b00cd-140">The NTLM protocol does not, however, guarantee server identity.</span></span> <span data-ttu-id="b00cd-141">Tal como acontece com todos os protocolos que utilizam o NTLM para autenticação, um atacante com acesso à conta de computador de um computador associado ao domínio conseguiu invocar o controlador de domínio para calcular uma chave de sessão NTLM e, deste modo, representar o servidor.</span><span class="sxs-lookup"><span data-stu-id="b00cd-141">As with all protocols that use NTLM for authentication, an attacker with access to a domain-joined computer's machine account could invoke the domain controller to compute an NTLM session-key and thereby impersonate the server.</span></span>

<span data-ttu-id="b00cd-142">Autenticação baseada em NTLM está desativada por predefinição, mas pode ser autorizada por qualquer um dos configurar SSL no servidor de destino ou configurar a definição de WinRM TrustedHosts no cliente.</span><span class="sxs-lookup"><span data-stu-id="b00cd-142">NTLM-based authentication is disabled by default, but may be permitted by either configuring SSL on the target server, or by configuring the WinRM TrustedHosts setting on the client.</span></span>

#### <a name="using-ssl-certificates-to-validate-server-identity-during-ntlm-based-connections"></a><span data-ttu-id="b00cd-143">Utilizar certificados SSL para validar a identidade do servidor durante a ligações de NTLM</span><span class="sxs-lookup"><span data-stu-id="b00cd-143">Using SSL certificates to validate server identity during NTLM-based connections</span></span>

<span data-ttu-id="b00cd-144">Uma vez que o protocolo de autenticação de NTLM não é possível garantir a identidade do servidor de destino (apenas que já sabe a palavra-passe), pode configurar os servidores de destino utilizem SSL para comunicação remota do PowerShell.</span><span class="sxs-lookup"><span data-stu-id="b00cd-144">Since the NTLM authentication protocol cannot ensure the identity of the target server (only that it already knows your password), you can configure target servers to use SSL for PowerShell Remoting.</span></span> <span data-ttu-id="b00cd-145">Atribuir um certificado SSL para o servidor de destino (se emitido por uma autoridade de certificação que o cliente também confianças) permite a autenticação baseada em NTLM que garante a identidade de utilizador e a identidade do servidor.</span><span class="sxs-lookup"><span data-stu-id="b00cd-145">Assigning a SSL certificate to the target server (if issued by a Certificate Authority that the client also trusts) enables NTLM-based authentication that guarantees both the user identity and server identity.</span></span>

#### <a name="ignoring-ntlm-based-server-identity-errors"></a><span data-ttu-id="b00cd-146">A ignorar erros de identidade do servidor com base em NTLM</span><span class="sxs-lookup"><span data-stu-id="b00cd-146">Ignoring NTLM-based server identity errors</span></span>

<span data-ttu-id="b00cd-147">Se implementar um certificado SSL para um servidor para ligações de NTLM é infeasible, pode suprimir os resultante erros de identidade ao adicionar o servidor para o WinRM **TrustedHosts** lista.</span><span class="sxs-lookup"><span data-stu-id="b00cd-147">If deploying a SSL certificate to a server for NTLM connections is infeasible, you may suppress the resulting identity errors by adding the server to the WinRM **TrustedHosts** list.</span></span> <span data-ttu-id="b00cd-148">Tenha em atenção que adicionar um nome de servidor à lista de TrustedHosts não deve ser considerado como qualquer outra forma de declaração de estado de fidedignidade dos anfitriões próprios – como o protocolo de autenticação de NTLM não pode garantir que está a ligar na realidade para o anfitrião estiver pretender ligar ao.</span><span class="sxs-lookup"><span data-stu-id="b00cd-148">Please note that adding a server name to the TrustedHosts list should not be considered as any form of statement of the trustworthiness of the hosts themselves - as the NTLM authentication protocol cannot guarantee that you are in fact connecting to the host you are intending to connect to.</span></span>
<span data-ttu-id="b00cd-149">Em vez disso, deve considerar a definição de TrustedHosts para ser a lista de anfitriões para os quais pretende suprimir erros gerados pelo facto de ser não é possível verificar a identidade do servidor.</span><span class="sxs-lookup"><span data-stu-id="b00cd-149">Instead, you should consider the TrustedHosts setting to be the list of hosts for which you wish to suppress the error generated by being unable to verify the server's identity.</span></span>


### <a name="ongoing-communication"></a><span data-ttu-id="b00cd-150">Comunicação em curso</span><span class="sxs-lookup"><span data-stu-id="b00cd-150">Ongoing Communication</span></span>

<span data-ttu-id="b00cd-151">Assim que a autenticação inicial estiver concluída, o [protocolo de comunicação remota de PowerShell](https://msdn.microsoft.com/library/dd357801.aspx) encripta todas as comunicações em curso com uma chave simétrica por sessão AES 256.</span><span class="sxs-lookup"><span data-stu-id="b00cd-151">Once initial authentication is complete, the [PowerShell Remoting Protocol](https://msdn.microsoft.com/library/dd357801.aspx) encrypts all ongoing communication with a per-session AES-256 symmetric key.</span></span>


## <a name="making-the-second-hop"></a><span data-ttu-id="b00cd-152">Tornar o segundo hop</span><span class="sxs-lookup"><span data-stu-id="b00cd-152">Making the second hop</span></span>

<span data-ttu-id="b00cd-153">Por predefinição, o sistema de interação remota do PowerShell utiliza NTLM ou Kerberos (se disponível) para autenticação.</span><span class="sxs-lookup"><span data-stu-id="b00cd-153">By default, PowerShell Remoting uses Kerberos (if available) or NTLM for authentication.</span></span> <span data-ttu-id="b00cd-154">Ambos estes protocolos autentiquem para o computador remoto sem enviar credenciais ao mesmo.</span><span class="sxs-lookup"><span data-stu-id="b00cd-154">Both of these protocols authenticate to the remote machine without sending credentials to it.</span></span>
<span data-ttu-id="b00cd-155">Esta é a forma mais segura de autenticar, mas porque o computador remoto não tem as credenciais do utilizador, não pode aceder a outros computadores e serviços em nome do utilizador.</span><span class="sxs-lookup"><span data-stu-id="b00cd-155">This is the most secure way to authenticate, but because the remote machine does not have the user's credentials, it cannot access other computers and services on the user's behalf.</span></span>
<span data-ttu-id="b00cd-156">Isto é conhecido como "segundo problema-salto".</span><span class="sxs-lookup"><span data-stu-id="b00cd-156">This is known as the "second hop problem".</span></span>

<span data-ttu-id="b00cd-157">Existem várias formas para evitar este problema.</span><span class="sxs-lookup"><span data-stu-id="b00cd-157">There are several ways to avoid this problem.</span></span> <span data-ttu-id="b00cd-158">Para obter descrições destes métodos e os profissionais de TI e contras de cada, consulte [tornando-o segundo hop comunicação remota do PowerShell](PS-remoting-second-hop.md).</span><span class="sxs-lookup"><span data-stu-id="b00cd-158">For descriptions of these methods, and the pros and cons of each, see [Making the second hop in PowerShell Remoting](PS-remoting-second-hop.md).</span></span>